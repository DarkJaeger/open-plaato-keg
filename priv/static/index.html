<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kegs</title>
    <style>
      @import url("style.css");
    </style>
</head>
<body>
  <div id="header_container">
    <div id="page_container" class="container pageEntry"></div>
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a
          role="button"
          class="navbar-burger burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarMenu"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarMenu" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item" href="/index.html">Home</a>
          <a class="navbar-item" href="/setup.html">Setup</a>
        </div>
      </div>
    </nav>
  </div>

    <section class="section">
        <div class="container">
            <h1 class="title is-1">Kegs</h1>

            <div class="columns is-multiline" id="kegContainer"></div>
        </div>
    </section>
  </div>

    <script>
      // Navbar burger menu
      const navbarBurgers = Array.prototype.slice.call(
        document.querySelectorAll(".navbar-burger"),
        0
      );

      if (navbarBurgers.length > 0) {
        navbarBurgers.forEach((el) => {
          el.addEventListener("click", () => {
            const target = el.dataset.target;
            const $target = document.getElementById(target);

            el.classList.toggle("is-active");
            $target.classList.toggle("is-active");
          });
        });
      }

        const kegContainer = document.getElementById('kegContainer');

        function createKegCard(kegData) {
            const column = document.createElement('div');
            column.classList.add('column', 'is-one-third'); // Responsive columns

            // Parse amount_left and keg_temperature as floats (they come as strings from the API)
            const amountLeft = parseFloat(kegData.amount_left) || 0;
            const maxVolume = parseFloat(kegData.max_keg_volume) || 0;
            const temperature = parseFloat(kegData.keg_temperature);
            const percentLeft = parseFloat(kegData.percent_of_beer_left) || 0;
            const rawUnit = kegData.beer_left_unit || 'L';
            const volumeUnit = rawUnit === 'litre' ? 'L' : rawUnit;
            const tempUnit = kegData.temperature_unit || 'Â°C';

            const lastPour = parseFloat(kegData.last_pour) || 0;
            const isPouring = kegData.is_pouring && kegData.is_pouring !== "0";

            // Build card title from beer style, keg date, and ABV (stored locally as my_beer_style, my_keg_date, my_abv)
            const beerStyle = kegData.my_beer_style?.trim();
            const kegDate = kegData.my_keg_date?.trim();
            const abv = kegData.my_abv?.trim();
            let cardTitle = '';
            if (beerStyle && kegDate) {
                cardTitle = `${beerStyle} <span style="color: #888; font-size: 0.8em; margin-left: 0.5em;">${kegDate}</span>`;
            } else if (beerStyle) {
                cardTitle = beerStyle;
            } else if (kegDate) {
                cardTitle = `<span style="color: #888; font-size: 0.8em;">${kegDate}</span>`;
            }
            // Add ABV if available
            if (abv) {
                cardTitle += ` <span style="color: #f59e0b; font-size: 0.8em; margin-left: 0.5em;">${abv}%</span>`;
            }

            const card = `
                <div class="card" data-keg-id="${kegData.id}">
                    <span class="temperature-badge">${!isNaN(temperature) ? temperature.toFixed(1) : '--'}${tempUnit}</span>
                    <span class="pouring-indicator ${isPouring ? 'is-pouring' : ''}" title="${isPouring ? 'POURING' : ''}"></span>
                    ${lastPour > 0 ? `<span class="last-pour-badge">LAST POUR: ${lastPour.toFixed(2)} ${volumeUnit}</span>` : ''}
                    <span class="remaining-badge">REMAINING: ${percentLeft.toFixed(1)}%</span>
                    <div class="card-content">
                        <div class="media">
                            <div class="media-content">
                                ${cardTitle ? `<p class="title is-5">${cardTitle}</p>` : ''}
                                <p class="subtitle is-1">${amountLeft.toFixed(2)} ${volumeUnit}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            column.innerHTML = card;
            return column;
        }

        // Fetch initial keg data
        fetch('/api/kegs')
            .then(response => response.json())
            .then(kegs => {
                if (kegs.length === 0) {
                    kegContainer.innerHTML = '<div class="column"><p class="has-text-grey">No kegs found. Connect a keg to see data here.</p></div>';
                } else {
                    kegs.forEach(keg => {
                        kegContainer.appendChild(createKegCard(keg));
                    });
                }
            })
            .catch(err => {
                kegContainer.innerHTML = '<div class="column"><p class="has-text-danger">Error loading kegs: ' + err.message + '</p></div>';
            });

        // WebSocket connection
        const socket = new WebSocket('/ws');

        socket.addEventListener('open', (event) => {
            console.log('WebSocket connection opened:', event);
        });

        socket.addEventListener('message', (event) => {
            const updatedKeg = JSON.parse(event.data);
            // Find the existing keg card and update its content
            const kegId = updatedKeg.id;
            const existingCard = document.querySelector(`#kegContainer [data-keg-id="${kegId}"]`);
            if (existingCard) {
                const newCard = createKegCard(updatedKeg);
                existingCard.innerHTML = newCard.querySelector('.card').innerHTML;
            } else if (kegId) {
                // New keg appeared, add it
                kegContainer.appendChild(createKegCard(updatedKeg));
            }
        });

        socket.addEventListener('error', (error) => {
            console.error('WebSocket error:', error);
        });

        socket.addEventListener('close', (event) => {
            console.log('WebSocket connection closed:', event);
        });
    </script>

</body>
</html>